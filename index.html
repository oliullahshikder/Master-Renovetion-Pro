<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Pro: AI Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #4f46e5; --glass: rgba(15, 23, 42, 0.95); }
        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: #050505;
            background-image: linear-gradient(rgba(0, 255, 170, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 255, 170, 0.03) 1px, transparent 1px);
            background-size: 40px 40px; color: white; min-height: 100vh;
            display: flex; align-items: center; justify-content: center; padding: 20px; overflow-x: hidden;
        }
        .cyber-wrapper {
            background: rgba(10, 10, 20, 0.90); border-radius: 40px;
            box-shadow: 0 0 0 2px #1e293b, 0 0 30px rgba(56, 189, 248, 0.15), 0 20px 50px rgba(0,0,0,0.9);
            backdrop-filter: blur(30px); width: 100%; max-width: 900px; padding: 40px 20px;
            border: 1px solid rgba(255, 255, 255, 0.08); transition: all 0.5s ease;
        }
        .android-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 20px; padding: 15px 10px; cursor: pointer; transition: transform 0.1s ease;
            width: 100%; height: 110px; border: none; user-select: none;
        }
        .btn-strict { background: linear-gradient(180deg, #0ea5e9 0%, #0369a1 100%); box-shadow: 0px 6px 0px #0c4a6e; }
        .btn-auto { background: linear-gradient(180deg, #d946ef 0%, #a21caf 100%); box-shadow: 0px 6px 0px #701a75; }
        .btn-reverse { background: linear-gradient(180deg, #f97316 0%, #c2410c 100%); box-shadow: 0px 6px 0px #7c2d12; }
        .android-btn.selected { transform: translateY(6px); box-shadow: inset 0px 5px 10px rgba(0,0,0,0.4); filter: brightness(1.1); }
        
        .input-3d { background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; color: white; transition: 0.3s; }
        .input-3d:focus { border-color: #38bdf8; background: rgba(0,0,0,0.9); outline: none; }
        .bangla-text { font-family: 'Hind Siliguri', sans-serif; line-height: 1.6; }

        /* Suggestion & Action Buttons */
        .suggestion-btn { background: linear-gradient(90deg, #8b5cf6, #ec4899); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 4px 10px rgba(236, 72, 153, 0.3); transition: 0.2s; cursor: pointer; min-width: 130px; text-align: center; }
        .suggestion-btn:active { transform: scale(0.95); }
        .suggestion-btn.loading { opacity: 0.8; cursor: wait; background: linear-gradient(90deg, #6366f1, #8b5cf6); }
        
        .offline-sugg-btn { background: linear-gradient(90deg, #f59e0b, #d97706); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3); transition: 0.2s; cursor: pointer; min-width: 90px; text-align: center; border-radius: 9999px; color: white; font-weight: bold; font-size: 9px; }
        .offline-sugg-btn:active { transform: scale(0.95); filter: brightness(1.1); }

        .round-3d-btn {
            width: 80px; height: 80px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 2px solid rgba(255,255,255,0.2); cursor: pointer; transition: transform 0.1s ease;
            color: white; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .round-3d-btn:active { transform: translateY(4px); box-shadow: none !important; }
        
        .btn-reset { background: radial-gradient(circle at 30% 30%, #ef4444, #991b1b); box-shadow: 0 6px 0 #7f1d1d, 0 10px 10px rgba(0,0,0,0.4); }
        .btn-offline-gen { background: radial-gradient(circle at 30% 30%, #eab308, #a16207); box-shadow: 0 6px 0 #854d0e, 0 10px 10px rgba(0,0,0,0.4); }
        .btn-edit { background: radial-gradient(circle at 30% 30%, #10b981, #047857); box-shadow: 0 6px 0 #065f46, 0 10px 10px rgba(0,0,0,0.4); width: 60px; height: 60px; font-size: 10px;}

        #workspace-area { max-height: 0; overflow: hidden; opacity: 0; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        #workspace-area.open { max-height: 3000px; opacity: 1; margin-top: 30px; padding-top: 20px; border-top: 1px dashed rgba(255,255,255,0.1); }
        .prompt-card { background: #111827; border-left: 4px solid; transition: transform 0.2s; }
        .prompt-card:hover { transform: translateX(5px); }
        
        /* Spinner */
        .cyber-spinner { width: 90px; height: 90px; border-radius: 50%; background: conic-gradient(#3b82f6, #ec4899, #eab308, #3b82f6); animation: spin 1.5s linear infinite; padding: 4px; margin: 0 auto; position: relative; }
        .cyber-spinner-inner { background: #0f172a; width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; z-index: 10; }
        #loaderTimerDisplay { font-weight: 800; font-size: 1.2rem; background: linear-gradient(to right, #38bdf8, #e879f9); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: pulse 1s infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } } 
        @keyframes pulse { 50% { opacity: 0.7; transform: scale(0.95); } }
        
        .badge-online { background: rgba(34, 197, 94, 0.2); border: 1px solid #22c55e; color: #4ade80; }
        .badge-offline { background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; color: #f87171; }
        .dev-signature { background: linear-gradient(to right, #38bdf8, #e879f9); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; letter-spacing: 0.3em; }
        
        #editor-panel { background: #0f172a; border: 1px solid #334155; border-radius: 16px; padding: 20px; margin-top: 20px; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <audio id="clickSound"><source src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.m4a" type="audio/mp4"></audio>

    <div class="cyber-wrapper flex flex-col items-center">
        <div class="text-center mb-8 w-full">
            <h1 class="text-5xl md:text-6xl font-extrabold text-white drop-shadow-[0_0_15px_rgba(56,189,248,0.5)]">MASTER PRO</h1>
            <p class="text-[10px] text-gray-400 uppercase tracking-[0.5em] mt-2">AI Construction Architect</p>
        </div>

        <div class="grid grid-cols-3 gap-4 w-full mb-2">
            <button onclick="toggleWorkspace('A')" id="btn-a" class="android-btn btn-strict group"><i class="fas fa-list-ol text-3xl mb-2 text-white"></i><span class="text-[10px] font-bold text-white tracking-widest">STRICT</span></button>
            <button onclick="toggleWorkspace('B')" id="btn-b" class="android-btn btn-auto group"><i class="fas fa-magic text-3xl mb-2 text-white"></i><span class="text-[10px] font-bold text-white tracking-widest">AUTO</span></button>
            <button onclick="toggleWorkspace('R')" id="btn-r" class="android-btn btn-reverse group"><i class="fas fa-history text-3xl mb-2 text-white"></i><span class="text-[10px] font-bold text-white tracking-widest">REVERSE</span></button>
        </div>

        <div id="workspace-area" class="w-full">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div id="project-name-group"><label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Project Name</label><input type="text" id="project_name" placeholder="e.g. Riverside Village House" class="w-full input-3d p-3"></div>
                <div><label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Type</label><select id="project_type" class="w-full input-3d p-3 bg-gray-900"><option value="Renovation">Renovation (Fix Old)</option><option value="Construction">Construction (Build New)</option></select></div>
                <div class="md:col-span-2"><label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Total Stages</label><select id="total_stages" onchange="renderDynamicInputs()" class="w-full input-3d p-3 bg-gray-900"><option value="3">3 Stages</option><option value="4">4 Stages</option><option value="5">5 Stages</option><option value="6" selected>6 Stages</option><option value="7">7 Stages</option></select></div>
            </div>
            
            <div id="dynamic-container" class="space-y-4 mb-6"></div>
            
            <div class="flex items-center justify-between gap-2 mt-4">
                <button onclick="clearAll()" class="round-3d-btn btn-reset"><i class="fas fa-trash-alt text-xl mb-1"></i><span class="text-[9px] uppercase tracking-wider">Reset</span></button>
                <button onclick="generatePrompts()" class="flex-grow h-20 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl font-bold text-white shadow-[0_6px_0_#4c1d95] border-t border-white/20 active:translate-y-1 active:shadow-none transition-all flex flex-col items-center justify-center"><i class="fas fa-bolt text-2xl mb-1 animate-pulse"></i><span class="text-sm tracking-widest">GENERATE PROMPTS</span></button>
                <button onclick="generateOfflineForce()" class="round-3d-btn btn-offline-gen"><i class="fas fa-microchip text-xl mb-1"></i><span class="text-[9px] uppercase tracking-wider leading-tight">Offline<br>Gen</span></button>
            </div>
        </div>

        <div id="result-section" class="w-full mt-8 hidden">
            <div id="loader" class="text-center mb-8 hidden">
                <div class="cyber-spinner"><div class="cyber-spinner-inner"><span id="loaderTimerDisplay">30s</span></div></div>
                <p class="text-xs text-blue-300 mt-4 font-mono font-bold tracking-widest animate-pulse">CONNECTING TO AI...</p>
            </div>
            <div id="output-container" class="space-y-4 hidden">
                <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-4"><h3 class="text-lg font-bold text-white">OUTPUT</h3><span id="status-badge" class="text-[9px] font-bold px-3 py-1 rounded-full flex items-center gap-2 border"></span></div>
                <div id="images-output" class="space-y-3"></div>
                <div id="videos-output" class="space-y-3"></div>
                <div id="beauty-output" class="space-y-3"></div>
                <button onclick="copyAll()" class="w-full bg-gray-800 p-3 rounded-lg text-xs font-bold text-gray-400 hover:text-white mt-4 border border-gray-700"><i class="fas fa-copy mr-2"></i> COPY ALL PROMPTS</button>
                
                <div id="editor-panel">
                    <label class="text-[10px] font-bold text-gray-400 uppercase flex items-center gap-2 mb-2"><i class="fas fa-edit text-green-400"></i> Sequence Editor (Smart)</label>
                    <div class="flex gap-2 items-start">
                        <textarea id="edit_instruction" class="w-full input-3d p-3 h-20 text-xs border-l-4 border-green-500" placeholder="e.g. 'Add a swimming pool after stage 3' OR 'Delete stage 2'"></textarea>
                        <button onclick="processEdit()" class="round-3d-btn btn-edit"><i class="fas fa-check text-xl mb-1"></i><span class="text-[8px] uppercase tracking-wider">EDIT</span></button>
                    </div>
                    <p class="text-[9px] text-gray-500 mt-2 italic">* Auto-updates Video Actions to match transition!</p>
                </div>
            </div>
        </div>

        <div class="text-center mt-10 border-t border-gray-800 w-full pt-4"><p class="text-[9px] text-gray-600 font-mono">SYSTEM ARCHITECT</p><h3 class="dev-signature">OLIULLAH SHIKDER JEWEL</h3></div>
    </div>

    <script>
        const offlineSuggestions = [
            "চীনের ঘন জঙ্গলের ভেতরে অত্যাধুনিক স্টাইলের একটি ডুপ্লেক্স কাঠের বাড়ি। বাড়ির চারপাশে সৌন্দর্যবর্ধনের জন্য সারি সারি নারিকেল গাছ।",
            "সিলেটের চা বাগানের চূড়ায় একটি আল্ট্রা-মডার্ন গ্লাস ভিলা। বাড়ির প্রতিটি দেয়াল স্বচ্ছ কাঁচের, যাতে ভেতর থেকে পুরো চা বাগান দেখা যায়।",
            "সুন্দরবনের গহীনে পিলারের উপর তৈরি একটি আধুনিক ইকো-লজ। লজটি সম্পূর্ণ কাঠ ও বাঁশ দিয়ে তৈরি কিন্তু ফিনিশিং ফাইভ-স্টার হোটেলের মতো।",
            "কক্সবাজারের সমুদ্র সৈকতের একদম কাছে একটি সাদা রঙের বিলাস বহুল বিচ ভিলা। ভিলাটি গ্রিক স্থাপত্যশৈলীতে তৈরি, নীল রঙের গম্বুজ এবং সাদা দেয়াল।",
            "গ্রামের মাঝখানে একটি রাজকীয় পুকুর পাড়ে আধুনিক দোতলা বাংলো। বাংলোর সামনে বিশাল শান বাঁধানো ঘাট, ঘাটের দুই পাশে দুটি বকুল ফুলের গাছ।"
        ];

        const appState = { A: { data: null, source: null, loading: false }, B: { data: null, source: null, loading: false }, R: { data: null, source: null, loading: false } };
        let currentMode = null; let uploadedImageName = null; let countdownTimer = null;
        let activePromptData = { images: [], videos: [], final_showcase: "" };

        // INITIALIZE
        window.onload = function() {
            toggleWorkspace('B');
        };

        const TIMEOUT_MS = 30000;
        const fetchWithTimeout = async (url, options) => {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), TIMEOUT_MS);
            try { const response = await fetch(url, { ...options, signal: controller.signal }); clearTimeout(id); return response; } catch (error) { clearTimeout(id); throw error; }
        };

        function playSound() { document.getElementById("clickSound").currentTime = 0; document.getElementById("clickSound").play().catch(e => {}); }
        
        function toggleWorkspace(mode) { 
            playSound();
            const workspace = document.getElementById('workspace-area');
            const clickedBtn = document.getElementById(`btn-${mode.toLowerCase()}`);
            if(!clickedBtn) return;

            if (currentMode === mode && workspace.classList.contains('open')) {
                workspace.classList.remove('open'); clickedBtn.classList.remove('selected'); currentMode = null; return;
            }
            currentMode = mode; 
            document.querySelectorAll('.android-btn').forEach(b => b.classList.remove('selected')); 
            clickedBtn.classList.add('selected'); workspace.classList.add('open'); 
            renderDynamicInputs(); restoreResultView(mode); 
        }
        function clearAll() { if(confirm("Reset Everything?")) { location.reload(); } }

        function startCountdown(targetId, duration = 30, textPrefix = "") {
            let timeLeft = duration; const el = document.getElementById(targetId); if(!el) return;
            el.innerHTML = textPrefix ? `${textPrefix} ${timeLeft}s` : `${timeLeft}s`;
            if(countdownTimer) clearInterval(countdownTimer);
            countdownTimer = setInterval(() => { timeLeft--; if(timeLeft >= 0) { el.innerHTML = textPrefix ? `${textPrefix} ${timeLeft}s` : `${timeLeft}s`; } else { clearInterval(countdownTimer); } }, 1000);
        }
        function stopCountdown() { if(countdownTimer) clearInterval(countdownTimer); }

        function fillOfflineSuggestion() {
            const box = document.getElementById('auto_desc');
            playSound();
            let random = offlineSuggestions[Math.floor(Math.random() * offlineSuggestions.length)];
            while(random === box.value) { random = offlineSuggestions[Math.floor(Math.random() * offlineSuggestions.length)]; }
            box.value = random;
            box.style.border = "1px solid #f59e0b"; setTimeout(() => box.style.border = "1px solid rgba(255,255,255,0.15)", 500);
        }

        async function fillSuggestion() { 
            const box = document.getElementById('auto_desc'); const btn = document.getElementById('sugg_btn');
            box.value = ""; box.placeholder = "Searching for natural concept...";
            btn.classList.add('loading'); btn.classList.remove('failed', 'sugg-online', 'sugg-offline'); 
            startCountdown('sugg_btn_text', 30, '<i class="fas fa-spinner fa-spin mr-1"></i> TRYING');
            try {
                const seed = Math.floor(Math.random() * 99999);
                const response = await fetchWithTimeout('https://text.pollinations.ai/', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ messages: [{ role: 'system', content: `Generate ONE unique, ultra-detailed architectural concept description in ENGLISH. RULES: REALISTIC, NATURAL, ORGANIC. NO SCI-FI. CLEAR DAYLIGHT. Describe landscaping, fences, flowers, furniture. Seed: ${seed}. Length: 60-80 words. Output ONLY the text.` }, { role: 'user', content: 'Give me a unique luxury natural architecture concept.' }], seed: seed, model: 'openai' })
                });
                if(!response.ok) throw new Error("API Error");
                const text = await response.text(); box.value = text.trim();
                stopCountdown(); document.getElementById('sugg_btn_text').innerHTML = `<i class="fas fa-wifi mr-1"></i> ENGLISH (ONLINE)`; btn.className = "suggestion-btn sugg-online text-[9px] font-bold text-white px-2 py-1 rounded-full";
            } catch (error) {
                fillOfflineSuggestion();
                stopCountdown(); document.getElementById('sugg_btn_text').innerHTML = `<i class="fas fa-leaf mr-1"></i> BANGLA (NATURAL)`; btn.className = "suggestion-btn sugg-offline text-[9px] font-bold text-white px-2 py-1 rounded-full";
            } finally {
                btn.classList.remove('loading'); box.style.border = "1px solid #ec4899"; setTimeout(() => box.style.border = "1px solid rgba(255,255,255,0.15)", 500);
            }
        }

        function renderDynamicInputs() {
            const container = document.getElementById('dynamic-container'); const stages = document.getElementById('total_stages').value; const nameGroup = document.getElementById('project-name-group'); container.innerHTML = "";
            
            if (!currentMode) return;

            if(currentMode === 'A') {
                nameGroup.classList.remove('hidden');
                for(let i=0; i<stages; i++) container.innerHTML += `<div><label class="text-[9px] font-bold text-gray-500 uppercase ml-2">${i===0?"Stage 1: Initial Ruin":i==stages-1?"Final Stage":"Stage "+(i+1)}</label><textarea id="inp_${i}" class="w-full input-3d p-3 h-20 text-sm border-l-4 ${i===0?'border-pink-500':'border-blue-500'}" placeholder="Description..."></textarea></div>`;
            } else if(currentMode === 'B') {
                nameGroup.classList.add('hidden');
                container.innerHTML = `<div class="flex justify-between items-end mb-1"><label class="text-[9px] font-bold text-gray-500 uppercase ml-2">Project Description</label><div class="flex gap-2"><button onclick="fillOfflineSuggestion()" class="offline-sugg-btn"><i class="fas fa-random"></i> MORE</button><button id="sugg_btn" onclick="fillSuggestion()" class="suggestion-btn text-[9px] font-bold text-white px-2 py-1 rounded-full"><span id="sugg_btn_text"><i class="fas fa-sparkles mr-1"></i>SUGGESTION</span></button></div></div><textarea id="auto_desc" class="w-full input-3d p-3 h-48 text-[11px] leading-relaxed border-l-4 border-purple-500 bangla-text text-gray-200" placeholder="Tap SUGGESTION for a natural idea..."></textarea>`;
                
                if (appState.B.lastInput) document.getElementById('auto_desc').value = appState.B.lastInput;
                else if(!appState.B.data) { const randomStart = offlineSuggestions[Math.floor(Math.random() * offlineSuggestions.length)]; document.getElementById('auto_desc').value = randomStart; }
            } else {
                nameGroup.classList.remove('hidden');
                container.innerHTML = `<label class="text-[9px] font-bold text-gray-500 uppercase ml-2">Final Image Description</label><textarea id="rev_desc" class="w-full input-3d p-3 h-24 text-sm border-l-4 border-orange-500 mb-4" placeholder="Describe final image..."></textarea><div class="border-2 border-dashed border-gray-700 rounded-xl p-4 text-center cursor-pointer bg-black/20" onclick="document.getElementById('f_up').click()"><i class="fas fa-images text-2xl text-gray-500 mb-2"></i><p class="text-xs text-gray-400" id="f_label">Tap to Open Gallery</p><input type="file" id="f_up" class="hidden" accept="image/*" onchange="uploadedImageName=this.files[0].name;document.getElementById('f_label').innerText=this.files[0].name"></div>`;
            }
        }

        function restoreResultView(mode) {
            if (!mode) return;
            const s = appState[mode]; const r = document.getElementById('result-section');
            if(s.loading) { r.classList.remove('hidden'); document.getElementById('loader').classList.remove('hidden'); document.getElementById('output-container').classList.add('hidden'); }
            else if(s.data) { r.classList.remove('hidden'); document.getElementById('loader').classList.add('hidden'); displayResults(s.data, s.source); }
            else { r.classList.add('hidden'); }
        }

        function getSafeContext() {
            let ctx = "";
            const mode = currentMode || 'B';
            
            if (mode === 'A') {
                const stages = parseInt(document.getElementById('total_stages').value);
                for(let i=0; i<stages; i++) {
                    const el = document.getElementById(`inp_${i}`);
                    if(el) ctx += `Stage ${i+1}: ${el.value}. `;
                }
            } else if (mode === 'B') {
                const el = document.getElementById('auto_desc');
                if (el) ctx = el.value.trim();
            } else {
                const el = document.getElementById('rev_desc');
                if (el) ctx = el.value.trim();
            }
            return String(ctx);
        }

        function getMaterialContext(desc) {
            const d = String(desc).toLowerCase();
            if (d.includes('ghat') || d.includes('shan') || d.includes('ঘাট') || d.includes('শান')) return { type: 'Masonry', foundation: 'Concrete/Brick underwater base', structure: 'Brick steps and platform', action: 'bricklaying and plastering' };
            if (d.includes('bamboo') || d.includes('বাঁশ')) return { type: 'Bamboo', foundation: 'Bamboo stilts/poles', structure: 'Bamboo framework', action: 'tying bamboo knots and assembling' };
            if (d.includes('wood') || d.includes('wooden') || d.includes('কাঠ')) return { type: 'Wood', foundation: 'Heavy timber posts or stone base', structure: 'Wooden framing', action: 'carpentry and sawing' };
            if (d.includes('mud') || d.includes('clay') || d.includes('মাটি')) return { type: 'Mud', foundation: 'Compacted earth foundation', structure: 'Mud walls', action: 'Applying mud plaster' };
            return { type: 'Modern', foundation: 'Concrete foundation', structure: 'Concrete/Brick walls', action: 'pouring concrete and bricklaying' };
        }

        function generateVideosFromImages(images, count, type, mat) {
            const videos = [];
            for (let i = 0; i < images.length - 1; i++) {
                let action = "";
                let progress = i / (images.length - 1); 

                if (type === 'Renovation') {
                    if (progress < 0.2) action = "thoroughly cleaning moss, removing all broken debris and vines";
                    else if (progress < 0.6) {
                        if(mat.type === 'Bamboo' || mat.type === 'Wood') action = `repairing damaged timbers, replacing broken planks/poles`;
                        else action = `repairing cracks in ${mat.structure}, reinforcing walls`;
                    }
                    else {
                        if(mat.type === 'Bamboo' || mat.type === 'Wood') action = "applying protective varnish/coating, installing wooden windows";
                        else action = "plastering walls, painting surfaces, installing glass windows";
                    }
                } else {
                    if (progress < 0.2) action = "clearing site, excavation and digging foundation";
                    else if (progress < 0.5) {
                         if(mat.type === 'Bamboo' || mat.type === 'Wood') action = `setting up wooden/bamboo posts, building framework`;
                         else action = `building concrete foundation, setting up pillars`;
                    }
                    else if (progress < 0.8) {
                         if(mat.type === 'Bamboo' || mat.type === 'Wood') action = `weaving bamboo walls, installing wooden planks for roof/floor`;
                         else action = `bricklaying walls, pouring concrete slab for roof`;
                    }
                    else {
                         if(mat.type === 'Bamboo' || mat.type === 'Wood') action = "finishing carpentry, applying oil/varnish, landscaping";
                         else action = "exterior plastering, painting, landscaping";
                    }
                }
                videos.push(`VIDEO PROMPT: Cinematic shot of 15+ professional workers in safety vests ${action} with relevant tools. 4k.`);
            }
            return videos;
        }

        async function generateOfflineForce() {
            playSound();
            const mode = currentMode || 'B';
            
            // MANUAL INPUT GRABBER
            const ctx = getSafeContext();
            
            if (mode === 'B') {
                const el = document.getElementById('auto_desc');
                if (!el || !el.value.trim()) { 
                    alert("Please write something in the description!"); 
                    return; 
                }
                appState.B.lastInput = el.value.trim();
            }

            const proj = document.getElementById('project_name').value || "Project"; 
            const type = document.getElementById('project_type').value; 
            const stages = parseInt(document.getElementById('total_stages').value);

            appState[mode].loading = true; restoreResultView(mode);
            await new Promise(r => setTimeout(r, 600));

            try {
                const generated = generateSmartLogic(proj, type, stages, ctx, mode);
                activePromptData = generated;
                appState[mode].data = generated;
                appState[mode].source = 'offline';
            } catch (e) {
                console.error(e);
                alert("Offline Generation Error.");
            }
            
            appState[mode].loading = false; restoreResultView(mode);
        }

        async function generatePrompts() {
            playSound();
            const mode = currentMode || 'B';
            
            if (mode === 'B') {
                const el = document.getElementById('auto_desc');
                if (!el || !el.value.trim()) { alert("Please write a description first!"); return; }
                appState.B.lastInput = el.value.trim();
            }

            const ctx = getSafeContext();
            appState[mode].loading = true; restoreResultView(mode);
            startCountdown('loaderTimerDisplay', 30);

            const proj = document.getElementById('project_name').value || "Project";
            const type = document.getElementById('project_type').value;
            const stages = parseInt(document.getElementById('total_stages').value);

            const prompt = `ACT AS MASTER PRO AI. PROJECT: ${proj}, TYPE: ${type}, STAGES: ${stages}. CONTEXT: ${ctx}.
            RULES: 1. Output JSON: {"images":[], "videos":[], "final_showcase":""}. 2. ENGLISH. 3. REALISTIC. 4. MATERIAL: IF Bamboo/Wood/Mud -> NO CONCRETE. 5. RENOVATION: Img 1=BROKEN. 6. CONSTRUCTION: Img 1=EMPTY. 7. IMG2IMG. 8. VIDEO ACTION. 9. NO HUMANS in IMG.`;

            try {
                const res = await fetchWithTimeout('https://text.pollinations.ai/', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ messages: [{ role: 'system', content: prompt }], model: 'openai' }) });
                const txt = await res.text(); const json = JSON.parse(txt.match(/\{[\s\S]*\}/)[0]);
                if(!json.images) throw new Error("Missing Images");
                activePromptData = json;
                appState[mode].data = json; appState[mode].source = 'online'; stopCountdown();
            } catch(e) {
                console.warn("Switching to Offline");
                generateOfflineForce(); 
                stopCountdown();
            } finally { appState[mode].loading = false; if(currentMode === mode) restoreResultView(mode); }
        }

        function generateSmartLogic(proj, type, count, ctx, mode) {
            const images = [];
            const coreDesc = ctx.substring(0, 300); 
            const baseConstraint = ", NO HUMANS, NO EQUIPMENT, NATURAL LIGHT, REALISTIC, 9:16 vertical ratio.";
            const contextInjection = `(Target Project Context: '${coreDesc.substring(0, 100)}...' - CURRENTLY UNDER CONSTRUCTION/RENOVATION)`;
            const editPhrase = `, IMG2IMG READY: KEEPING SAME CAMERA ANGLE & GEOMETRY OF PREVIOUS STEP. ${contextInjection}, `;
            const mat = getMaterialContext(coreDesc);

            if(mode === 'R') {
                images.push(`PROMPT: (Stage 1 - Final) Ultra-realistic 8k shot of completed project: '${coreDesc}', masterpiece${baseConstraint}`);
                for(let i=1; i<count; i++) {
                    let desc = i===count-1 ? "Abandoned site, debris" : "Noticeable demolition, parts removed";
                    images.push(`PROMPT: (Stage ${i+1} - Reverse) ${editPhrase}${desc}${baseConstraint}`);
                }
            } else {
                let isRenovation = type === 'Renovation';
                for(let i=0; i<count; i++) {
                    let prompt = "";
                    if(i === 0) {
                        if(isRenovation) { 
                            prompt = `PROMPT: (Stage 1 - Base) Ultra-realistic 8k shot of EXISTING DILAPIDATED STRUCTURE. Broken, covered in vines, rotten wood/debris scattered. (Context: Site for '${coreDesc.substring(0,50)}...')${baseConstraint}`; 
                        } else { 
                            prompt = `PROMPT: (Stage 1 - Base) Ultra-realistic 8k shot of EMPTY WILD LAND. Nature only. NO BUILDING EXISTS YET. (Context: Future site for '${coreDesc.substring(0,50)}...')${baseConstraint}`; 
                        }
                    } 
                    else if(i === 1) {
                        if(isRenovation) { 
                            prompt = `PROMPT: (Stage 2 - Thorough Cleaning) ${editPhrase} The site is THOROUGHLY CLEANED. All broken debris, rotten parts, and garbage completely removed. Only the main structural skeleton (${mat.structure}) remains standing clean. Surrounding nature intact. NO LEFTOVER MATERIAL VISIBLE${baseConstraint}`; 
                        } else { 
                            prompt = `PROMPT: (Stage 2 - Excavation) ${editPhrase} The land is cleared. Large EXCAVATION PITS dug into the ground for foundation. Piles of dirt visible. Still no building. DO NOT SHOW FINISHED HOUSE${baseConstraint}`; 
                        }
                    }
                    else if(i === count - 1) { 
                        prompt = `PROMPT: (Final) ${editPhrase} The project is finished. ${coreDesc}. Modern architecture, luxury finishes applied, landscaping added, beautiful lighting${baseConstraint}`; 
                    }
                    else {
                        // MIDDLE STAGES (Strict Material Logic - Massive Visual Change)
                        let remainingStages = count - 3; let midIndex = i - 2; let stageDesc = "";
                        let progressPercent = (midIndex / remainingStages) * 100;

                        if(isRenovation) { 
                            if(mat.type === 'Bamboo' || mat.type === 'Wood') {
                                 if(progressPercent < 50) stageDesc = `MASSIVE CHANGE: Replacing all damaged timbers/bamboo. Main frame is solid and new. Roof structure installed but open`;
                                 else stageDesc = `MASSIVE CHANGE: Installing new wooden planks/bamboo weaves for walls. Applying protective varnish coating. Structure looks almost new but unfinished`;
                            } else {
                                 if(progressPercent < 50) stageDesc = `MASSIVE CHANGE: Major structural repair complete. Roof slab/frame installed. Walls reinforced`;
                                 else stageDesc = `MASSIVE CHANGE: Exterior plastering done. Windows installed. Painting base coat started`;
                            }
                        } else {
                            if(mat.type === 'Bamboo' || mat.type === 'Wood') {
                                if (progressPercent < 40) stageDesc = `MASSIVE CHANGE: Wooden/Bamboo posts fully set up. Main structural framework standing tall from foundation`;
                                else if (progressPercent < 70) stageDesc = `MASSIVE CHANGE: Walls woven/planked. Roof framing complete. House shape clearly visible`;
                                else stageDesc = `MASSIVE CHANGE: Roofing installed. Windows framed. Finishing carpentry work visible`;
                            } else {
                                if (progressPercent < 40) stageDesc = `MASSIVE CHANGE: Foundation complete. Concrete pillars and ground floor walls rising significantly`;
                                else if (progressPercent < 70) stageDesc = `MASSIVE CHANGE: Main structure fully erected. Roof slab poured. Brick walls complete`;
                                else stageDesc = `MASSIVE CHANGE: Exterior plastering finished. Windows framed. Building looks solid but unpainted`;
                            }
                        }
                        prompt = `PROMPT: (Stage ${i+1} - Massive Progress) ${editPhrase} ${stageDesc}. Construction visible. DO NOT SHOW FINISHED HOUSE${baseConstraint}`;
                    }
                    images.push(prompt);
                }
            }

            const videos = generateVideosFromImages(images, count, type, mat);
            return { images, videos, final_showcase: `Cinematic beauty showcase video of '${coreDesc}', drone view, 4k.` };
        }

        function processEdit() {
            playSound();
            const instruction = document.getElementById('edit_instruction').value.toLowerCase();
            if(!instruction) return alert("Please write an instruction!");
            
            const stageMatch = instruction.match(/(\d+)/); 
            const targetStageIndex = stageMatch ? parseInt(stageMatch[0]) : activePromptData.images.length - 1; 
            const isDelete = instruction.includes('delete') || instruction.includes('remove') || instruction.includes('বাদ');
            const isAdd = !isDelete;

            let newImages = [...activePromptData.images];
            const coreDesc = getSafeContext();
            const baseConstraint = ", NO HUMANS, NO EQUIPMENT, NATURAL LIGHT, REALISTIC, 9:16 vertical ratio.";
            const editPhrase = ", IMG2IMG READY: KEEPING SAME CAMERA ANGLE & GEOMETRY OF PREVIOUS STEP, ";

            if (isDelete) {
                if(targetStageIndex > 0 && targetStageIndex <= newImages.length) newImages.splice(targetStageIndex - 1, 1);
            } else {
                const newPrompt = `PROMPT: (Stage New - Edited) ${editPhrase} ${instruction.replace(/stage \d+/i, '').replace(/after|before/i, '').trim()}. Context: ${coreDesc}. Construction/Renovation logic applies${baseConstraint}`;
                if(instruction.includes('after') || instruction.includes('পরে')) newImages.splice(targetStageIndex, 0, newPrompt);
                else if (instruction.includes('before') || instruction.includes('আগে')) newImages.splice(Math.max(0, targetStageIndex - 1), 0, newPrompt);
                else newImages.splice(newImages.length - 1, 0, newPrompt);
            }
            
            newImages = newImages.map((p, i) => {
                let cleanP = p.replace(/PROMPT: \(Stage \d+ -/, `PROMPT: (Stage ${i+1} -`).replace(/\(Stage New -/, `PROMPT: (Stage ${i+1} -`); 
                if(i === newImages.length - 1 && !cleanP.includes('Final')) cleanP = cleanP.replace(/- [^)]+/, '- Final');
                return cleanP;
            });

            const type = document.getElementById('project_type').value;
            const mat = getMaterialContext(coreDesc);
            const newVideos = generateVideosFromImages(newImages, newImages.length, type, mat);

            activePromptData.images = newImages;
            activePromptData.videos = newVideos;
            
            if(isAdd && instruction.includes('final') || instruction.includes('শেষে')) {
                 activePromptData.final_showcase = `Cinematic beauty showcase video of '${coreDesc}' with updates: ${instruction}. Drone view, 4k.`;
            }

            displayResults(activePromptData, 'offline');
            document.getElementById('edit_instruction').value = "";
        }

        function displayResults(data, src) {
            const iBox = document.getElementById('images-output'), vBox = document.getElementById('videos-output'), bBox = document.getElementById('beauty-output');
            const type = document.getElementById('project_type').value;
            iBox.innerHTML=""; vBox.innerHTML=""; bBox.innerHTML=""; document.getElementById('output-container').classList.remove('hidden');
            
            const badge = document.getElementById('status-badge');
            let sourceText = src === 'online' ? "ONLINE AI" : "SMART LOGIC";
            let colorClass = src === 'online' ? "badge-online" : "badge-offline";
            
            badge.className = `${colorClass} text-[9px] font-bold px-3 py-1 rounded-full flex gap-2 border`;
            badge.innerHTML = `<i class="fas fa-${src === 'online' ? 'wifi' : 'brain'}"></i> ${sourceText} • ${type.toUpperCase()}`;

            const card = (t,txt,c) => `<div class="prompt-card p-4 rounded-lg bg-gray-800 border-l-4 ${c} shadow-lg"><div class="flex justify-between mb-2"><span class="text-[10px] font-bold text-gray-400 uppercase">${t}</span><i class="fas fa-copy text-gray-500 cursor-pointer hover:text-white" onclick="navigator.clipboard.writeText(this.parentElement.nextElementSibling.innerText)"></i></div><p class="text-xs text-gray-300 font-mono leading-relaxed select-all">${txt}</p></div>`;

            data.images.forEach((t,i)=> iBox.innerHTML+=card(`IMG ${i+1}`,t,'border-pink-500'));
            if(data.videos) data.videos.forEach((t,i)=> vBox.innerHTML+=card(`VIDEO ${i+1}`,t,'border-blue-500'));
            if(data.final_showcase) bBox.innerHTML=card("FINAL SHOWCASE",data.final_showcase,'border-yellow-500');
            document.getElementById('output-container').scrollIntoView({behavior:'smooth'});
        }

        function copyAll() { let t=""; document.querySelectorAll('.prompt-text').forEach(e=>t+=e.innerText+"\n\n"); navigator.clipboard.writeText(t); alert("Copied!"); }
    </script>
</body>
</html>
