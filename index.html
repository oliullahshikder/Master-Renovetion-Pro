<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Pro V7: Perfect Logic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #4f46e5; --glass: rgba(15, 23, 42, 0.95); }
        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: #050505;
            background-image: linear-gradient(rgba(0, 255, 170, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 255, 170, 0.03) 1px, transparent 1px);
            background-size: 40px 40px; color: white; min-height: 100vh;
            display: flex; align-items: center; justify-content: center; padding: 20px; overflow-x: hidden;
        }
        .cyber-wrapper {
            background: rgba(10, 10, 20, 0.90); border-radius: 40px;
            box-shadow: 0 0 0 2px #1e293b, 0 0 30px rgba(56, 189, 248, 0.15), 0 20px 50px rgba(0,0,0,0.9);
            backdrop-filter: blur(30px); width: 100%; max-width: 900px; padding: 40px 20px;
            border: 1px solid rgba(255, 255, 255, 0.08); transition: all 0.5s ease;
        }
        
        .android-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 20px; padding: 15px 10px; cursor: pointer; transition: transform 0.1s ease;
            width: 100%; height: 110px; border: none; user-select: none;
        }
        .btn-strict { background: linear-gradient(180deg, #0ea5e9 0%, #0369a1 100%); box-shadow: 0px 6px 0px #0c4a6e; }
        .btn-auto { background: linear-gradient(180deg, #d946ef 0%, #a21caf 100%); box-shadow: 0px 6px 0px #701a75; }
        .btn-reverse { background: linear-gradient(180deg, #f97316 0%, #c2410c 100%); box-shadow: 0px 6px 0px #7c2d12; }
        .android-btn.selected { transform: translateY(6px); box-shadow: inset 0px 5px 10px rgba(0,0,0,0.4); filter: brightness(1.2); border: 2px solid white; }
        
        .input-3d { background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; color: white; transition: 0.3s; }
        .input-3d:focus { border-color: #38bdf8; background: rgba(0,0,0,0.9); outline: none; }
        
        .suggestion-btn { 
            background: linear-gradient(90deg, #8b5cf6, #ec4899); 
            border: 1px solid rgba(255,255,255,0.2); 
            box-shadow: 0 4px 10px rgba(236, 72, 153, 0.3); 
            transition: 0.2s; cursor: pointer; 
            padding: 5px 15px; border-radius: 999px;
            font-size: 10px; font-weight: bold; color: white;
            display: flex; align-items: center; gap: 5px;
        }
        .suggestion-btn:active { transform: scale(0.95); }
        .offline-sugg-btn { background: linear-gradient(90deg, #f59e0b, #d97706); padding: 5px 10px; border-radius: 999px; font-size: 10px; font-weight: bold; cursor: pointer; }

        .round-3d-btn { width: 80px; height: 80px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid rgba(255,255,255,0.2); cursor: pointer; transition: transform 0.1s ease; color: white; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .round-3d-btn:active { transform: translateY(4px); box-shadow: none !important; }
        
        .btn-reset { background: radial-gradient(circle at 30% 30%, #ef4444, #991b1b); box-shadow: 0 6px 0 #7f1d1d; }
        .btn-offline-gen { background: radial-gradient(circle at 30% 30%, #eab308, #a16207); box-shadow: 0 6px 0 #854d0e; }
        .btn-edit { background: radial-gradient(circle at 30% 30%, #10b981, #047857); box-shadow: 0 6px 0 #065f46; width: 60px; height: 60px; font-size: 10px; display: flex; align-items: center; justify-content: center; }

        #workspace-area { max-height: 0; overflow: hidden; opacity: 0; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); margin-top: 0; }
        #workspace-area.open { max-height: 3000px; opacity: 1; margin-top: 30px; padding-top: 20px; border-top: 1px dashed rgba(255,255,255,0.1); }
        
        .prompt-card { background: #111827; border-left: 4px solid; padding: 15px; margin-bottom: 10px; border-radius: 8px; }
        #editor-panel { background: #0f172a; border: 1px solid #334155; border-radius: 16px; padding: 20px; margin-top: 20px; }
        
        .cyber-spinner { width: 60px; height: 60px; border-radius: 50%; background: conic-gradient(#3b82f6, #ec4899, #eab308, #3b82f6); animation: spin 1.5s linear infinite; padding: 4px; margin: 0 auto; }
        .cyber-spinner-inner { background: #0f172a; width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <audio id="clickSound"><source src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.m4a" type="audio/mp4"></audio>

    <div class="cyber-wrapper flex flex-col items-center">
        <div class="text-center mb-8 w-full">
            <h1 class="text-5xl md:text-6xl font-extrabold text-white drop-shadow-[0_0_15px_rgba(56,189,248,0.5)]">MASTER PRO</h1>
            <p class="text-[10px] text-gray-400 uppercase tracking-[0.5em] mt-2">AI Construction Architect</p>
        </div>

        <div class="grid grid-cols-3 gap-4 w-full mb-2">
            <button onclick="toggleWorkspace('A')" id="btn-a" class="android-btn btn-strict group"><i class="fas fa-list-ol text-3xl mb-2 text-white"></i><span class="text-[10px] font-bold text-white tracking-widest">STRICT</span></button>
            <button onclick="toggleWorkspace('B')" id="btn-b" class="android-btn btn-auto group"><i class="fas fa-magic text-3xl mb-2 text-white"></i><span class="text-[10px] font-bold text-white tracking-widest">AUTO</span></button>
            <button onclick="toggleWorkspace('R')" id="btn-r" class="android-btn btn-reverse group"><i class="fas fa-history text-3xl mb-2 text-white"></i><span class="text-[10px] font-bold text-white tracking-widest">REVERSE</span></button>
        </div>

        <div id="workspace-area" class="w-full">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div><label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Project Name</label><input type="text" id="project_name" placeholder="e.g. Riverside Village House" class="w-full input-3d p-3"></div>
                <div><label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Type</label><select id="project_type" class="w-full input-3d p-3 bg-[#0f172a]"><option value="Renovation">Renovation (Fix Old)</option><option value="Construction">Construction (Build New)</option></select></div>
                <div class="md:col-span-2"><label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Total Stages</label><select id="total_stages" onchange="handleStageChange()" class="w-full input-3d p-3 bg-[#0f172a]"><option value="3">3 Stages</option><option value="4">4 Stages</option><option value="5">5 Stages</option><option value="6" selected>6 Stages</option><option value="7">7 Stages</option></select></div>
            </div>
            
            <div id="container-b" class="mb-4 hidden">
                <div class="flex justify-between items-end mb-1">
                    <label class="text-[10px] font-bold text-gray-500 uppercase ml-2">Description / Concept</label>
                    <div class="flex gap-2">
                        <button onclick="fillOfflineSuggestion()" class="offline-sugg-btn"><i class="fas fa-random"></i> BACKUP</button>
                        <button id="sugg_btn" onclick="fillSuggestion()" class="suggestion-btn"><i class="fas fa-sparkles"></i> <span id="sugg_btn_text">SUGGESTION</span></button>
                    </div>
                </div>
                <textarea id="auto_desc" class="w-full input-3d p-3 h-48 text-[11px] leading-relaxed border-l-4 border-purple-500 bangla-text text-gray-200" placeholder="Tap 'SUGGESTION' to generate a detailed material plan..."></textarea>
            </div>

            <div id="container-a" class="space-y-4 mb-4 hidden"></div>

            <div id="container-r" class="mb-4 hidden">
                <label class="text-[10px] font-bold text-gray-500 uppercase ml-2">Final Image Description</label>
                <textarea id="rev_desc" class="w-full input-3d p-3 h-24 text-sm border-l-4 border-orange-500" placeholder="Describe the finished building..."></textarea>
            </div>
            
            <div class="flex items-center justify-between gap-2 mt-4">
                <button onclick="clearAll()" class="round-3d-btn btn-reset"><i class="fas fa-trash-alt text-xl mb-1"></i><span class="text-[9px] uppercase tracking-wider">Reset</span></button>
                <button onclick="generatePrompts()" class="flex-grow h-20 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl font-bold text-white shadow-[0_6px_0_#4c1d95] border-t border-white/20 active:translate-y-1 active:shadow-none transition-all flex flex-col items-center justify-center"><i class="fas fa-bolt text-2xl mb-1 animate-pulse"></i><span class="text-sm tracking-widest">GENERATE PROMPTS</span></button>
                <button onclick="generateOfflineForce()" class="round-3d-btn btn-offline-gen"><i class="fas fa-microchip text-xl mb-1"></i><span class="text-[9px] uppercase tracking-wider leading-tight">Offline<br>Gen</span></button>
            </div>
        </div>

        <div id="result-section" class="w-full mt-8 hidden">
            <div id="loader" class="text-center mb-8 hidden">
                <div class="cyber-spinner"><div class="cyber-spinner-inner"><span id="loaderTimerDisplay">30s</span></div></div>
                <p class="text-xs text-blue-300 mt-4 font-mono font-bold tracking-widest animate-pulse">ANALYZING LOGIC...</p>
            </div>
            <div id="output-container" class="space-y-6 hidden">
                <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-4">
                    <h3 class="text-lg font-bold text-white">OUTPUT</h3>
                    <span id="status-badge" class="text-[9px] font-bold px-3 py-1 rounded-full flex items-center gap-2 border"></span>
                </div>
                
                <div id="images-output" class="space-y-3"></div>
                <div id="videos-output" class="space-y-3"></div>
                <div id="beauty-output" class="space-y-3"></div>
                
                <button onclick="copyAll()" class="w-full bg-gray-800 p-3 rounded-lg text-xs font-bold text-gray-400 hover:text-white mt-4 border border-gray-700"><i class="fas fa-copy mr-2"></i> COPY ALL DATA</button>

                <div id="editor-panel">
                    <label class="text-[10px] font-bold text-gray-400 uppercase flex items-center gap-2 mb-2"><i class="fas fa-edit text-green-400"></i> Sequence Editor (Smart)</label>
                    <div class="flex gap-2 items-start">
                        <textarea id="edit_instruction" class="w-full input-3d p-3 h-20 text-xs border-l-4 border-green-500" placeholder="e.g. 'Add a swimming pool after stage 3' OR 'Delete stage 2'"></textarea>
                        <button onclick="processEdit()" class="round-3d-btn btn-edit"><i class="fas fa-check text-xl mb-1"></i><span class="text-[8px] uppercase tracking-wider">EDIT</span></button>
                    </div>
                    <p class="text-[9px] text-gray-500 mt-2 italic">* Auto-regenerates images and video actions based on edits!</p>
                </div>
            </div>
        </div>

        <div class="text-center mt-10 border-t border-gray-800 w-full pt-4"><p class="text-[9px] text-gray-600 font-mono">SYSTEM ARCHITECT</p><h3 class="dev-signature">OLIULLAH SHIKDER JEWEL</h3></div>
    </div>

    <script>
        const offlineSuggestions = [
            "Project: Eco-Bamboo Villa. Foundation: Bamboo Stilts. Walls: Woven Bamboo. Roof: Thatch. Stairs: Bamboo. Landscape: Tropical Garden.",
            "Project: Modern Concrete Mosque. Foundation: Reinforced Concrete. Walls: Brick & Plaster. Roof: Green Dome. Stairs: Marble. Landscape: Fountain & Flowers.",
            "Project: Hillside Wooden Cottage. Foundation: Stone & Timber. Walls: Pine Planks. Roof: Tin Sheets. Stairs: Wooden Logs. Landscape: Wildflowers."
        ];

        const appState = { A: { data: null, source: null, loading: false }, B: { data: null, source: null, loading: false }, R: { data: null, source: null, loading: false } };
        let currentMode = null; let activePromptData = { images: [], videos: [], final_showcase: "" };
        let countdownTimer = null;
        let onlineTimeout = null;
        let suggestionTimer = null;

        // INIT
        function playSound() { document.getElementById("clickSound").currentTime = 0; document.getElementById("clickSound").play().catch(e => {}); }
        
        function toggleWorkspace(mode) { 
            playSound();
            const workspace = document.getElementById('workspace-area');
            const clickedBtn = document.getElementById(`btn-${mode.toLowerCase()}`);
            if(!clickedBtn) return;

            if (currentMode === mode && workspace.classList.contains('open')) {
                workspace.classList.remove('open'); clickedBtn.classList.remove('selected'); currentMode = null; return;
            }
            
            document.querySelectorAll('.android-btn').forEach(b => b.classList.remove('selected')); 
            clickedBtn.classList.add('selected'); 
            workspace.classList.add('open'); 
            
            currentMode = mode;
            document.getElementById('container-a').classList.add('hidden');
            document.getElementById('container-b').classList.add('hidden');
            document.getElementById('container-r').classList.add('hidden');
            
            if(mode === 'A') {
                document.getElementById('container-a').classList.remove('hidden');
                renderStrictInputsOnly();
            } else if(mode === 'B') {
                document.getElementById('container-b').classList.remove('hidden');
                if(!document.getElementById('auto_desc').value) fillOfflineSuggestion();
            } else {
                document.getElementById('container-r').classList.remove('hidden');
            }
            
            restoreResultView(mode); 
        }

        function handleStageChange() { if(currentMode === 'A') renderStrictInputsOnly(); }

        function renderStrictInputsOnly() {
            const container = document.getElementById('container-a'); 
            const stages = document.getElementById('total_stages').value; 
            container.innerHTML = "";
            for(let i=0; i<stages; i++) container.innerHTML += `<div><label class="text-[9px] font-bold text-gray-500 uppercase ml-2">Stage ${i+1}</label><textarea id="inp_${i}" class="w-full input-3d p-3 h-20 text-sm border-l-4 border-blue-500"></textarea></div>`;
        }

        function clearAll() { if(confirm("Reset Everything?")) { location.reload(); } }

        function startCountdown(targetId, duration = 30) {
            let timeLeft = duration; const el = document.getElementById(targetId); if(!el) return;
            el.innerHTML = `${timeLeft}s`;
            if(countdownTimer) clearInterval(countdownTimer);
            countdownTimer = setInterval(() => { 
                timeLeft--; 
                if(timeLeft >= 0) { el.innerHTML = `${timeLeft}s`; } 
                else { clearInterval(countdownTimer); } 
            }, 1000);
        }
        function stopCountdown() { if(countdownTimer) clearInterval(countdownTimer); }

        function fillOfflineSuggestion() {
            const box = document.getElementById('auto_desc');
            playSound();
            let random = offlineSuggestions[Math.floor(Math.random() * offlineSuggestions.length)];
            box.value = random;
            box.style.border = "1px solid #f59e0b"; setTimeout(() => box.style.border = "1px solid rgba(255,255,255,0.15)", 500);
        }

        // --- NEW UPDATED SUGGESTION LOGIC ---
        async function fillSuggestion() { 
            const box = document.getElementById('auto_desc'); 
            const btn = document.getElementById('sugg_btn_text');
            const parentBtn = document.getElementById('sugg_btn');
            
            // Prevent double click
            if(parentBtn.disabled) return;
            
            box.value = ""; box.placeholder = "Contacting AI Brain...";
            
            // Start Button Countdown (30s)
            let timeLeft = 30;
            btn.innerHTML = `WAIT (${timeLeft}s)`;
            parentBtn.disabled = true;
            
            // Reset Styles
            parentBtn.style.background = "linear-gradient(90deg, #8b5cf6, #ec4899)";
            parentBtn.style.border = "1px solid rgba(255,255,255,0.2)";

            // Timer Interval
            if(suggestionTimer) clearInterval(suggestionTimer);
            suggestionTimer = setInterval(() => {
                timeLeft--;
                btn.innerHTML = `WAIT (${timeLeft}s)`;
                
                // IF TIMEOUT (30s passed)
                if(timeLeft <= 0) {
                    clearInterval(suggestionTimer);
                    triggerOfflineSuggestionFallback(btn, parentBtn);
                }
            }, 1000);
            
            try {
                const seed = Math.floor(Math.random() * 99999);
                const systemPrompt = `You are an expert construction architect. Provide a detailed concept description strictly listing materials for each part.
                Format: "Project: [Name]. Foundation: [Material]. Walls: [Material]. Roof: [Material]. Stairs: [Material]. Landscape: [Details]."
                Ensure NO conflicting materials (e.g., if Bamboo walls, do not use Concrete roof). Keep it under 80 words.`;
                
                const response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: 'Unique luxury natural architectural concept.' }], seed: seed, model: 'openai' })
                });
                
                if(!response.ok) throw new Error("API Error");
                
                const text = await response.text(); 
                
                // SUCCESS
                clearInterval(suggestionTimer);
                box.value = text.trim();
                
                // GREEN STATUS
                btn.innerHTML = "ONLINE SUGG";
                parentBtn.disabled = false;
                parentBtn.style.background = "linear-gradient(90deg, #22c55e, #16a34a)";
                parentBtn.style.border = "1px solid #4ade80";
                
            } catch (error) {
                // ERROR CATCH
                clearInterval(suggestionTimer);
                triggerOfflineSuggestionFallback(btn, parentBtn);
            }
        }

        function triggerOfflineSuggestionFallback(btnSpan, btnElem) {
            fillOfflineSuggestion(); // Fill box with backup
            
            // RED STATUS
            btnSpan.innerHTML = "OFFLINE SUGG";
            btnElem.disabled = false;
            btnElem.style.background = "linear-gradient(90deg, #ef4444, #b91c1c)";
            btnElem.style.border = "1px solid #f87171";
        }

        function restoreResultView(mode) {
            if(!mode) return;
            const s = appState[mode]; const r = document.getElementById('result-section');
            if(s.loading) { r.classList.remove('hidden'); document.getElementById('loader').classList.remove('hidden'); document.getElementById('output-container').classList.add('hidden'); }
            else if(s.data) { r.classList.remove('hidden'); document.getElementById('loader').classList.add('hidden'); displayResults(s.data, s.source); }
            else { r.classList.add('hidden'); }
        }

        function getSafeContext() {
            let ctx = "";
            const mode = currentMode || 'B';
            try {
                if (mode === 'A') {
                    const stages = parseInt(document.getElementById('total_stages').value);
                    for(let i=0; i<stages; i++) {
                        const el = document.getElementById(`inp_${i}`);
                        if(el && el.value) ctx += `Stage ${i+1}: ${el.value}. `;
                    }
                } else if (mode === 'B') {
                    const el = document.getElementById('auto_desc');
                    if (el && el.value) ctx = el.value.trim();
                } else {
                    const el = document.getElementById('rev_desc');
                    if (el && el.value) ctx = el.value.trim();
                }
            } catch(e) {}
            return String(ctx);
        }

        function getMaterialContext(desc) {
            const d = String(desc).toLowerCase();
            
            if (d.includes('bamboo') || d.includes('বাঁশ')) {
                return { 
                    type: 'Bamboo', 
                    foundation: 'Bamboo stilts', 
                    actions: [
                        'setting up main bamboo poles and floor frame',
                        'weaving bamboo walls and installing roof frame',
                        'thatching the roof and installing bamboo windows',
                        'varnishing bamboo and adding finishing touches'
                    ]
                };
            }
            if (d.includes('wood') || d.includes('wooden') || d.includes('কাঠ')) {
                return { 
                    type: 'Wood', 
                    foundation: 'Timber posts', 
                    actions: [
                        'erecting main timber columns and floor beams',
                        'constructing wooden walls with planks and framing windows',
                        'installing roof trusses and wooden shingles',
                        'polishing wood, painting, and landscaping'
                    ]
                };
            }
            if (d.includes('tin') || d.includes('টিন')) {
                 return { 
                    type: 'Tin/Wood', 
                    foundation: 'Brick pillars', 
                    actions: [
                        'building brick pillars and floor base',
                        'erecting wooden frames for walls',
                        'installing corrugated tin sheets on roof',
                        'painting the tin roof and landscaping'
                    ]
                };
            }
            return { 
                type: 'Concrete', 
                foundation: 'Concrete foundation', 
                actions: [
                    'casting concrete columns and floor slab',
                    'bricklaying walls and installing door frames',
                    'casting roof slab and plastering walls',
                    'painting, installing glass, and tiling'
                ]
            };
        }

        function generateVideosFromImages(images, count, type, mat) {
            const videos = [];
            const targetCount = images.length - 1;
            
            for (let i = 0; i < targetCount; i++) {
                let action = "";
                
                if (type === 'Renovation') {
                    if (i === 0) action = "cleaning debris and removing broken parts";
                    else if (i === targetCount - 1) action = "finishing painting and landscaping";
                    else {
                        action = `repairing the ${mat.type} structure by ${mat.actions[i-1] || 'reinforcing walls'}`;
                    }
                } else {
                    if (i === 0) action = "excavation and site clearing";
                    else if (i === 1) action = `building foundation with ${mat.type} materials`;
                    else {
                        let actIdx = i - 2; 
                        if (actIdx < 0) actIdx = 0;
                        if (actIdx >= mat.actions.length) actIdx = mat.actions.length - 1;
                        action = mat.actions[actIdx];
                    }
                }
                videos.push(`VIDEO PROMPT: Cinematic shot of 15+ professional workers in safety vests doing ${action}. 4k.`);
            }
            return videos;
        }

        async function generateOfflineForce() {
            playSound();
            const mode = currentMode || 'B';
            const ctx = getSafeContext();
            if (mode === 'B' && !document.getElementById('auto_desc').value) return alert("Write something!");

            const proj = document.getElementById('project_name').value || "Project"; 
            const type = document.getElementById('project_type').value; 
            const stages = parseInt(document.getElementById('total_stages').value);

            document.getElementById('result-section').classList.remove('hidden');
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('output-container').classList.add('hidden');
            
            await new Promise(r => setTimeout(r, 600));

            const generated = generateSmartLogic(proj, type, stages, ctx, mode);
            activePromptData = generated;
            appState[mode].data = generated;
            appState[mode].source = 'offline';
            
            document.getElementById('loader').classList.add('hidden');
            displayResults(activePromptData, 'offline');
        }

        async function generatePrompts() {
            playSound(); const mode = currentMode || 'B';
            const ctx = getSafeContext();
            if (mode === 'B' && !document.getElementById('auto_desc').value) return alert("Write something!");

            document.getElementById('result-section').classList.remove('hidden');
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('output-container').classList.add('hidden');
            startCountdown('loaderTimerDisplay', 30);

            if(onlineTimeout) clearTimeout(onlineTimeout);
            onlineTimeout = setTimeout(() => {
                console.warn("Timeout reached. Switching to Offline.");
                generateOfflineForce();
                stopCountdown();
            }, 30000); 

            const proj = document.getElementById('project_name').value || "Project";
            const type = document.getElementById('project_type').value;
            const stages = parseInt(document.getElementById('total_stages').value);

            const prompt = `ACT AS MASTER PRO AI. PROJECT: ${proj}, TYPE: ${type}, STAGES: ${stages}. CONTEXT: ${ctx}.
            IMPORTANT: Return ONLY valid JSON format. No Markdown.
            Structure: {"images": ["prompt1", "prompt2"...], "videos": ["video1"...], "final_showcase": "prompt"}
            RULES: 
            1. **IMG 2 to N:** Start with "Edit previous image by...".
            2. **MATERIAL:** Strictly follow materials in CONTEXT (e.g. if Tin Roof, do not use Concrete Roof).
            3. **RENOVATION:** Img 1=BROKEN. Img 2=CLEAN SKELETON (No Debris).
            4. **CONSTRUCTION:** Img 1=EMPTY LAND. Img 2=FOUNDATION.
            5. **IMG FORMAT:** Add ", 9:16 vertical ratio" to ALL image prompts.`;

            try {
                const res = await fetch('https://text.pollinations.ai/', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ messages: [{ role: 'system', content: prompt }], model: 'openai' })
                });
                const txt = await res.text();
                const cleanTxt = txt.replace(/```json/g, '').replace(/```/g, '').trim();
                const jsonMatch = cleanTxt.match(/\{[\s\S]*\}/);
                
                if(jsonMatch) {
                    clearTimeout(onlineTimeout);
                    let json = JSON.parse(jsonMatch[0]);
                    
                    json.images = json.images.map(img => img.includes("9:16") ? img : img + ", 9:16 vertical ratio.");
                    
                    if(!json.videos || json.videos.length < stages - 1) {
                        const mat = getMaterialContext(ctx);
                        json.videos = generateVideosFromImages(json.images, stages, type, mat);
                    }

                    activePromptData = json;
                    appState[mode].data = json; appState[mode].source = 'online';
                    stopCountdown();
                    document.getElementById('loader').classList.add('hidden');
                    if(currentMode === mode) displayResults(activePromptData, 'online'); 
                } else { throw new Error("Invalid"); }
            } catch(e) {
                // Timeout handles fallback
            }
        }

        function generateSmartLogic(proj, type, count, ctx, mode) {
            const images = [];
            const coreDesc = ctx.substring(0, 300); 
            const mat = getMaterialContext(coreDesc);
            const baseConstraint = ", REALISTIC, 8k, 9:16 aspect ratio.";
            
            const editPrefix = "Edit previous image by ";

            if(mode === 'R') {
                images.push(`PROMPT: (Stage 1 - Final) Finished: '${coreDesc}'${baseConstraint}`);
                for(let i=1; i<count; i++) images.push(`PROMPT: (Stage ${i+1} - Reverse) ${editPrefix} removing parts, showing demolition phase ${i}${baseConstraint}`);
            } else {
                let isRenovation = type === 'Renovation';
                for(let i=0; i<count; i++) {
                    let prompt = "";
                    if(i === 0) {
                        if(isRenovation) prompt = `PROMPT: (Stage 1 - Base) EXISTING BROKEN STRUCTURE. Mossy, abandoned. Context: '${coreDesc}'${baseConstraint}`;
                        else prompt = `PROMPT: (Stage 1 - Base) EMPTY LAND. Nature only. Context: '${coreDesc}'${baseConstraint}`;
                    } else if(i === 1) {
                        if(isRenovation) prompt = `PROMPT: (Stage 2 - Cleaning) ${editPrefix} removing ALL debris. Clean Skeleton standing. NO TRASH. Context: '${coreDesc}'${baseConstraint}`;
                        else prompt = `PROMPT: (Stage 2 - Foundation) ${editPrefix} digging foundation pits for ${mat.type} base. Context: '${coreDesc}'${baseConstraint}`;
                    } else if(i === count - 1) {
                        prompt = `PROMPT: (Final) ${editPrefix} adding luxury details, lighting, and landscaping. Finished project: '${coreDesc}'${baseConstraint}`;
                    } else {
                        let actionIndex = i - 2; 
                        if (actionIndex < 0) actionIndex = 0;
                        if (actionIndex >= mat.actions.length) actionIndex = mat.actions.length - 1;
                        
                        let actionText = mat.actions[actionIndex];
                        prompt = `PROMPT: (Stage ${i+1} - Progress) ${editPrefix} ${actionText}. Context: '${coreDesc}'${baseConstraint}`;
                    }
                    images.push(prompt);
                }
            }
            
            const videos = generateVideosFromImages(images, count, type, mat);
            return { images, videos, final_showcase: `Cinematic drone video of '${coreDesc}'` };
        }

        function processEdit() {
            const instr = document.getElementById('edit_instruction').value.toLowerCase();
            if(!instr) return alert("Write instruction!");
            
            const newPrompt = `PROMPT: (Edited Step) Edit previous image by ${instr}. Context: ${getSafeContext()}`;
            activePromptData.images.splice(activePromptData.images.length-1, 0, newPrompt);
            
            const type = document.getElementById('project_type').value;
            const mat = getMaterialContext(getSafeContext());
            const newVideos = generateVideosFromImages(activePromptData.images, activePromptData.images.length, type, mat);
            activePromptData.videos = newVideos;

            displayResults(activePromptData, 'offline');
            document.getElementById('edit_instruction').value = "";
        }

        function displayResults(data, src) {
            const iBox = document.getElementById('images-output'), vBox = document.getElementById('videos-output'), bBox = document.getElementById('beauty-output');
            iBox.innerHTML=""; vBox.innerHTML=""; bBox.innerHTML=""; document.getElementById('output-container').classList.remove('hidden');
            
            const badge = document.getElementById('status-badge');
            
            if(src === 'online') {
                badge.className = "text-[9px] font-bold px-3 py-1 rounded-full flex gap-2 border bg-green-900/30 border-green-500 text-green-400";
                badge.innerHTML = `<i class="fas fa-wifi"></i> ONLINE AI`;
            } else {
                badge.className = "text-[9px] font-bold px-3 py-1 rounded-full flex gap-2 border bg-red-900/30 border-red-500 text-red-400";
                badge.innerHTML = `<i class="fas fa-microchip"></i> OFFLINE LOGIC`;
            }

            const card = (t,txt,c) => `<div class="prompt-card border-l-4 ${c} shadow-lg"><div class="flex justify-between mb-2"><span class="text-[10px] font-bold text-gray-400 uppercase">${t}</span><i class="fas fa-copy text-gray-500 cursor-pointer hover:text-white" onclick="navigator.clipboard.writeText(this.parentElement.nextElementSibling.innerText)"></i></div><p class="text-xs text-gray-300 font-mono leading-relaxed select-all">${txt}</p></div>`;

            if(data.images) data.images.forEach((t,i)=> iBox.innerHTML+=card(`IMG ${i+1}`,t,'border-pink-500'));
            if(data.videos) data.videos.forEach((t,i)=> vBox.innerHTML+=card(`VIDEO ${i+1}`,t,'border-blue-500'));
            if(data.final_showcase) bBox.innerHTML=card("FINAL SHOWCASE",data.final_showcase,'border-yellow-500');
            document.getElementById('output-container').scrollIntoView({behavior:'smooth'});
        }

        function copyAll() { let t=""; document.querySelectorAll('.select-all').forEach(e=>t+=e.innerText+"\n\n"); navigator.clipboard.writeText(t); alert("Copied!"); }
    </script>
</body>
</html>
